name: Secrets and code scan

on:
  push:
    branches:
      - '**'  # This will trigger on all tags
    tags:
      - '**'  # This will trigger on all tags
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Disable incremental compilation for faster from-scratch builds
  CARGO_INCREMENTAL: 0
  CARGO_TERM_COLOR: always

jobs:
  test:
    uses: ./.github/workflows/test.yml
    secrets: inherit
  file-scan:
    needs: ["test"]
    uses: ./.github/workflows/scan.yml
    secrets: inherit
  cargo-audit:
    needs: ["test"]
    uses: ./.github/workflows/audit.yml
    secrets: inherit
  build-and-deploy:
    needs: ["test", "file-scan"]
    uses: ./.github/workflows/build-and-deploy.yml
    secrets: inherit
  #container-scan:
  #  needs: ["test", "file-scan", "build-and-deploy"]
  #  uses: ./.github/workflows/container-scan.yml
  #  secrets: inherit
  zap-scan:
    needs: ["test", "file-scan", "build-and-deploy"]
    uses: ./.github/workflows/zap-scan.yml
    secrets: inherit
